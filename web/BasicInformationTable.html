<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>個案資料輸入與匯出 v0.2.0</title>
  <!-- 表單樣式 -->
  <style id="formStyles">
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f0f2f5;
    }
    input,textarea,select,option{
      font-size: 24px;
    }
    form#caseForm {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    button {
      background: #4a90e2;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #357ab8;
    }
    .form-section {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .form-section h2 {
      margin: 0 0 8px;
      padding-bottom: 8px;
      border-bottom: 2px solid #4a90e2;
      font-size: 28px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      column-gap: 16px;
      row-gap: 12px;
      align-items: center;
    }
    .form-grid textarea {
      resize: vertical;
      min-height: 60px;
    }
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      column-gap: 16px;
      row-gap: 12px;
    }
    .contacts .contact {
      margin-bottom: 12px;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      position: relative;
    }
    .contacts .contact .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    #familyTreePreview {
      max-width: 100%;
      margin-top: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #downloadBtn {
      display: block;
      margin: 20px auto 0;
    }
    .top-controls {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      margin-bottom:12px;
    }
  </style>

  <!-- 匯出頁面樣式 -->
  <style id="exportStyles">
    @page {
      size: A4;
      margin: 10mm;
    }
    body, html {
      margin: 0;
      padding: 0;
      font-size: 24px;
    }
    h1 {
      text-align: center;
    }
    .page {
      width: 1000px;
      min-height: 1120px;
      margin: 20px auto;
      padding: 40px;
      box-sizing: border-box;
      background: #fff;
      page-break-after: always;
    }
    .section-block {
      margin-top: 24px;
    }
    .section-block h2 {
      margin: 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #4a90e2;
      font-size: 28px;
    }
    .field-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px 24px;
      margin-top: 12px;
    }
    .field {
      display: flex;
    }
    .field .label {
      flex-shrink: 0;
      width: 100px;
      font-weight: bold;
      white-space: nowrap;
      font-size: 24px;
      margin: 16px;
    }
    .field .value {
      flex: 1;
      font-size: 24px;
      margin: 16px;
      white-space: normal;
      word-break: break-all;
      overflow-wrap: break-word;
      min-width: 0;
    }
    /* 單一欄位跨滿整行，只有超出頁面寬度才換行 */
    .field-grid .field:last-child {
      grid-column: 1 / -1;
    }

    /* 家系圖置中 */
    .family-tree-img {
      display: block;
      margin: 12px auto;
      max-width: 100%;
      border: 1px solid #ccc;
    }
    .two-col-output {
      display: flex;
      gap: 40px;
      margin-top: 12px;
    }
    .two-col-output .col .label {
      font-weight: bold;
      margin-bottom: 4px;
    }
    /* 5 欄緊急聯絡人 */
    .contact-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px 16px;
      margin-top: 12px;
    }
    .contact-grid .header {
      font-weight: bold;
      background: #f3f3f3;
      padding: 8px;
    }
    .contact-grid .cell {
      padding: 8px;
      word-break: break-all;
    }
  </style>
</head>
<body>

  <div class="top-controls">
    <!-- 新增：匯入匯出檔案（載入匯出 HTML 並回填表單） -->
    <input type="file" id="importFileInput" accept=".html,text/html" />
    <button type="button" id="importBtn">載入匯出檔並回填表單</button>
  </div>

  <form id="caseForm">
    <select name="facility" id="facilitySelect">
      <option>新北市私立豐禾老人長期照顧中心(養護型)</option>
      <option>新北市私立靜園老人長期照顧中心(養護型)</option>
    </select>
    <input type="text" id="formTitle" placeholder="E1路人甲基本資料表" />
    <!-- 一、個案基本資料 -->
    <section class="form-section">
      <h2>一、個案基本資料</h2>
      <div class="form-grid">
        <label>姓名</label><input type="text" name="name" />
        <label>性別</label>
        <select name="gender">
          <option>女</option>
          <option>男</option>
        </select>
        <label>體檢醫院</label><input type="text" name="hospital" />
        <label>入住日期</label><input type="date" name="checkinDate" />
        <label>出生日期</label><input type="date" name="dob" />
        <label>身分證</label><input type="text" name="idNo" />
        <label>戶籍地址</label><input type="text" name="address" />
      </div>
    </section>

    <!-- 二、緊急聯絡人 -->
    <section class="form-section contacts">
      <h2>二、緊急聯絡人 <button type="button" id="addContactBtn">＋新增</button></h2>
      <div id="contacts-container"></div>
    </section>

    <!-- 三、社會福利別 -->
    <section class="form-section">
      <h2>三、社會福利別</h2>
      <div class="form-grid">
        <label>身份別</label>
        <select name="socialId">
          <option>一般戶</option>
          <option>中低1.5</option>
          <option>榮民</option>
          <option>榮眷</option>
        </select>
        <label>保險種類</label>
        <select name="insuranceType">
          <option>健保</option>
          <option>健保及農保</option>
          <option>健保及勞保</option>
        </select>
        <label>經濟來源</label>
        <select name="incomeSource">
          <option>子女供養</option>
          <option>父母供養</option>
          <option>退休俸</option>
        </select>
        <label>身障證明</label><input type="text" name="disabilityProof" />
      </div>
    </section>

    <!-- 四、生理 / 心理功能評估 -->
    <section class="form-section">
      <h2>四、生理 / 心理功能評估</h2>
      <div class="form-grid">
        <label>認知狀態</label>
        <select name="cognition">
          <option>混亂</option>
          <option>清醒</option>
          <option>無法評估</option>
        </select>
        <label>輔具使用</label><input type="text" name="assistiveDevices" />
        <label>管路</label>
        <select name="tubes">
          <option>無</option>
          <option>鼻胃管</option>
          <option>導尿管</option>
          <option>鼻胃管及導尿管</option>
        </select>
        <label>表達能力</label>
        <select name="expression">
          <option>差</option>
          <option>佳</option>
          <option>無法表達</option>
        </select>
        <label>飲食形態</label>
        <select name="diet">
          <option>軟質</option>
          <option>管灌</option>
        </select>
        <label>入住意願</label>
        <select name="admission">
          <option>可接受</option>
          <option>被告知無反應</option>
          <option>無法接受</option>
          <option>未被告知</option>
        </select>
        <label>評估摘要</label><textarea name="evalSummary"></textarea>
      </div>
    </section>

    <!-- 五、家庭及社會評估 -->
    <section class="form-section">
      <h2>五、家庭及社會評估</h2>
      <div class="form-grid">
        <label>教育程度</label>
        <select name="education">
          <option>小學</option>
          <option>中學</option>
          <option>高中職</option>
          <option>大學以上</option>
          <option>不識字</option>
        </select>
        <label>過去職業</label><input type="text" name="pastJob" />
        <label>申請服務原因</label>
        <select name="serviceReason">
          <option>親人無力照顧</option>
          <option>自願入住</option>
        </select>
        <label>居住情形</label>
        <select name="livingSituation">
          <option>與子女同住</option>
          <option>與配偶同住</option>
          <option>獨居</option>
        </select>
        <label>婚姻狀況</label>
        <select name="maritalStatus">
          <option>喪偶</option>
          <option>已婚</option>
          <option>離婚</option>
          <option>未婚</option>
          <option>同居</option>
          <option>分居</option>
        </select>
        <label>生活作息</label>
        <select name="dailyRoutine">
          <option>混亂</option>
          <option>規律</option>
        </select>
        <label>主要照顧者</label><input type="text" name="mainCarer" />
        <label>主要決策者</label><input type="text" name="mainDecisionMaker" />
        <label>宗教信仰</label>
        <select name="religion">
          <option>民間信仰</option>
          <option>佛教</option>
          <option>道教</option>
          <option>基督教</option>
          <option>一貫道</option>
        </select>
        <label>家庭關係</label><textarea name="familyRelation"></textarea>
      </div>
    </section>

    <!-- 六、家系圖 -->
    <section class="form-section">
      <h2>六、家系圖 📷</h2>
      <input type="file" accept="image/*" id="familyTreeInput" />
      <img id="familyTreePreview" src="" alt="家系圖預覽" />
    </section>

    <!-- 七、助力／阻力 -->
    <section class="form-section">
      <h2>七、助力及阻力</h2>
      <div class="two-col">
        <div>
          <label>助力</label>
          <textarea name="strengths"></textarea>
        </div>
        <div>
          <label>阻力</label>
          <textarea name="barriers"></textarea>
        </div>
      </div>
    </section>

    <!-- 八、個案來源與退住日期 -->
    <section class="form-section">
      <h2>八、個案來源與退住日期</h2>
      <div class="form-grid">
        <label>個案來源</label>
        <select name="caseSource">
          <option>自行聯絡</option>
          <option>醫院轉介</option>
          <option>其他機構</option>
        </select>
        <label>退住日期</label><input type="date" name="checkoutDate" />
      </div>
    </section>

    <button type="button" id="downloadBtn">生成表單</button>
    <a href="./生活公約及權力義務.html">生活公約</a>
  </form>

  <!-- 緊急聯絡人範本 -->
  <template id="contactTpl">
    <div class="contact">
      <button type="button" class="remove-btn">×</button>
      <div class="form-grid">
        <label>姓名</label><input type="text" name="contactName[]" />
        <label>關係</label><input type="text" name="contactRelation[]" />
        <label>市內電話</label><input type="text" name="contactTel[]" />
        <label>手機</label><input type="text" name="contactMobile[]" />
        <label>住址</label><input type="text" name="contactAddress[]" />
      </div>
    </div>
  </template>

  <script>
    let familyTreeDataUrl = '';

    // 新增／移除緊急聯絡人
    function addContact(fields = {}) {
      const tpl = document.getElementById('contactTpl').content.cloneNode(true);
      const removeBtn = tpl.querySelector('.remove-btn');
      removeBtn.addEventListener('click', e => {
        e.target.closest('.contact').remove();
      });
      // 填入預設值（若有）
      if (fields.name) tpl.querySelector('input[name="contactName[]"]').value = fields.name;
      if (fields.rel)  tpl.querySelector('input[name="contactRelation[]"]').value = fields.rel;
      if (fields.tel)  tpl.querySelector('input[name="contactTel[]"]').value = fields.tel;
      if (fields.mob)  tpl.querySelector('input[name="contactMobile[]"]').value = fields.mob;
      if (fields.addr) tpl.querySelector('input[name="contactAddress[]"]').value = fields.addr;

      document.getElementById('contacts-container').appendChild(tpl);
    }

    document.getElementById('addContactBtn').addEventListener('click', () => addContact());

    // 家系圖預覽（上傳）
    document.getElementById('familyTreeInput').addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        familyTreeDataUrl = e.target.result;
        document.getElementById('familyTreePreview').src = familyTreeDataUrl;
      };
      reader.readAsDataURL(file);
    });

    // 通用：生成 3 欄式欄位網格
    function renderFieldGrid(items) {
      let html = '<div class="field-grid">';
      items.forEach(({ label, value }) => {
        html += `
          <div class="field">
            <div class="label">${label}：</div>
            <div class="value">${value}</div>
          </div>`;
      });
      html += '</div>';
      return html;
    }

    // 通用：生成文字區塊
    function renderSection(title, items) {
      return `
        <div class="section-block">
          <h2>${title}</h2>
          ${renderFieldGrid(items)}
        </div>`;
    }

    // 通用：生成家系圖區塊
    function renderImageSection(title, imageUrl) {
      return `
        <div class="section-block">
          <h2>${title}</h2>
          ${imageUrl
            ? `<img src="${imageUrl}" class="family-tree-img" alt="${title}"/>`
            : '<div style="margin-top:12px;">（尚未上傳家系圖）</div>'}
        </div>`;
    }

    // 通用：生成雙欄區塊
    function renderTwoColumnSection(title, left, right) {
      return `
        <div class="section-block">
          <h2>${title}</h2>
          <div class="two-col-output">
            <div class="col">
              <div class="label">${left.label}：</div>
              <div class="value">${left.value}</div>
            </div>
            <div class="col">
              <div class="label">${right.label}：</div>
              <div class="value">${right.value}</div>
            </div>
          </div>
        </div>`;
    }

    // ===== 新增：5 欄緊急聯絡人 =====
    function renderContactsSection(title, contacts) {
      let html = `
        <div class="section-block">
          <h2>${title}</h2>
          <div class="contact-grid">
            <div class="header">姓名</div>
            <div class="header">關係</div>
            <div class="header">市內電話</div>
            <div class="header">手機</div>
            <div class="header">住址</div>`;
      contacts.forEach(c => {
        html += `
            <div class="cell">${c.name}</div>
            <div class="cell">${c.rel}</div>
            <div class="cell">${c.tel}</div>
            <div class="cell">${c.mob}</div>
            <div class="cell">${c.addr}</div>`;
      });
      return html + `
          </div>
        </div>`;
    }

    // 生成並下載 HTML
    document.getElementById('downloadBtn').addEventListener('click', () => {
      const formEl = document.getElementById('caseForm');
      const fd = new FormData(formEl);
      const G = key => fd.get(key) || '';

      // 從 FormData 取得多筆聯絡人欄位
      const names = fd.getAll('contactName[]');
      const rels  = fd.getAll('contactRelation[]');
      const tels  = fd.getAll('contactTel[]');
      const mobs  = fd.getAll('contactMobile[]');
      const addrs = fd.getAll('contactAddress[]');

      // 組成 contacts 陣列
      const contacts = names.map((name, i) => ({
        name:  name   || '',
        rel:   rels[i]   || '',
        tel:   tels[i]   || '',
        mob:   mobs[i]   || '',
        addr:  addrs[i]  || ''
      }));

      // 各區塊欄位資料
      const basics = [
        { label: '姓名', value: G('name') },
        { label: '性別', value: G('gender') },
        { label: '體檢醫院', value: G('hospital') },
        { label: '入住日期', value: G('checkinDate') },
        { label: '出生日期', value: G('dob') },
        { label: '身分證', value: G('idNo') },
        { label: '戶籍地址', value: G('address') }
      ];
      const social = [
        { label: '身份別', value: G('socialId') },
        { label: '保險種類', value: G('insuranceType') },
        { label: '經濟來源', value: G('incomeSource') },
        { label: '身障證明', value: G('disabilityProof') }
      ];
      const evaluation = [
        { label: '認知狀態', value: G('cognition') },
        { label: '輔具使用', value: G('assistiveDevices') },
        { label: '管路', value: G('tubes') },
        { label: '表達能力', value: G('expression') },
        { label: '飲食形態', value: G('diet') },
        { label: '入住意願', value: G('admission') },
        { label: '評估摘要', value: G('evalSummary') }
      ];
      const familySocial = [
        { label: '教育程度', value: G('education') },
        { label: '過去職業', value: G('pastJob') },
        { label: '入住原因', value: G('serviceReason') },
        { label: '居住情形', value: G('livingSituation') },
        { label: '婚姻狀況', value: G('maritalStatus') },
        { label: '生活作息', value: G('dailyRoutine') },
        { label: '照顧者', value: G('mainCarer') },
        { label: '決策者', value: G('mainDecisionMaker') },
        { label: '宗教信仰', value: G('religion') },
        { label: '家庭關係', value: G('familyRelation') }
      ];
      const caseSource = [ 
        { label: '個案來源', value: G('caseSource') },
        { label: '退住日期', value: G('checkoutDate')},
        { label: '主管', value: ''},
        { label: '填表者', value: ''}
      ];
      const treeUrl = familyTreeDataUrl;

      // 組頁內容
      const pages = [];
      pages.push(`
        <div class="page">
          <h1>${G('facility')}</h1>
          <h1>住民基本資料表</h1>
          ${renderSection('一、個案基本資料', basics)}
          ${renderContactsSection('二、緊急聯絡人', contacts)}
          ${renderSection('三、社會福利別', social)}
          ${renderSection('四、生理／心理功能評估', evaluation)}
        </div>`);
      pages.push(`
        <div class="page">
          ${renderSection('五、家庭及社會評估', familySocial)}
          ${renderImageSection('六、家系圖', treeUrl)}
          ${renderTwoColumnSection('七、助力及阻力',
            { label: '助力', value: G('strengths') },
            { label: '阻力', value: G('barriers') }
          )}
          ${renderSection('八、個案來源與退住日期',
            caseSource
          )}
        </div>`);

      // 最終 HTML
      const exportCss = document.getElementById('exportStyles').innerText;
      const finalHtml = `<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>個案資料報表</title>
  <style>${exportCss}</style>
</head>
<body>
  ${pages.join('')}
</body>
</html>`;

      // 觸發下載
      const blob = new Blob([finalHtml], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const safeTitle = (document.getElementById('formTitle').value || '住民基本資料表').replace(/\s+/g, "_");
      a.href = url;
      a.download = `${safeTitle}.html`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // ============================
    // 匯入功能：載入匯出檔並回填表單
    // ============================
    document.getElementById('importBtn').addEventListener('click', () => {
      const fileInput = document.getElementById('importFileInput');
      const f = fileInput.files && fileInput.files[0];
      if (!f) {
        alert('請先選擇匯出的 HTML 檔案（由「生成表單」下載）。');
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        try {
          parseExportHtml(e.target.result);
          alert('已從匯出檔回填表單（如有家系圖會顯示）。');
        } catch (err) {
          console.error(err);
          alert('解析匯出檔時發生錯誤，請確認檔案是由本系統「生成表單」匯出的 HTML。');
        }
      };
      reader.readAsText(f, 'utf-8');
    });

    // 解析匯出 HTML 並回填表單
    function parseExportHtml(htmlText) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlText, 'text/html');

      // 1) 優先取第一個 h1 作為 facility（匯出時第一個 h1 存放機構名稱）
      const h1s = doc.querySelectorAll('h1');
      if (h1s && h1s.length > 0) {
        const facility = h1s[0].textContent.trim();
        setSelectOrCreate(document.querySelector('select[name="facility"]'), facility);
      }

      // 2) 收集所有 .field（label / value）對
      const fields = {};
      const fieldNodes = doc.querySelectorAll('.field');
      fieldNodes.forEach(f => {
        const lblEl = f.querySelector('.label');
        const valEl = f.querySelector('.value');
        if (!lblEl || !valEl) return;
        let label = lblEl.textContent.replace(/：/g, '').trim();
        let value = valEl.textContent.trim();
        fields[label] = value;
      });

      // 3) mapping：將輸出 label 對應回表單 name
      const labelToName = {
        '姓名':'name','性別':'gender','體檢醫院':'hospital','入住日期':'checkinDate',
        '出生日期':'dob','身分證':'idNo','戶籍地址':'address','身份別':'socialId',
        '保險種類':'insuranceType','經濟來源':'incomeSource','身障證明':'disabilityProof',
        '認知狀態':'cognition','輔具使用':'assistiveDevices','管路':'tubes','表達能力':'expression',
        '飲食形態':'diet','入住意願':'admission','評估摘要':'evalSummary',
        '教育程度':'education','過去職業':'pastJob','入住原因':'serviceReason','居住情形':'livingSituation',
        '婚姻狀況':'maritalStatus','生活作息':'dailyRoutine','照顧者':'mainCarer','決策者':'mainDecisionMaker',
        '宗教信仰':'religion','家庭關係':'familyRelation','個案來源':'caseSource','退住日期':'checkoutDate',
        '助力':'strengths','阻力':'barriers','主管':'supervisor','填表者':'filler'
      };

      // 填入欄位（文字 / select / textarea / date）
      Object.entries(labelToName).forEach(([label, name]) => {
        if (!(label in fields)) return;
        const val = fields[label];
        const el = document.querySelector(`[name="${name}"]`);
        if (!el) {
          // 若無對應欄位（例如 supervisor / filler），忽略或可以擴充處理
          return;
        }
        if (el.tagName === 'INPUT') {
          // date 或 text
          // 如果是 date 輸入，嘗試解析成 yyyy-mm-dd（匯出通常是原值）
          if (el.type === 'date') {
            // 如果匯出的格式為 yyyy-mm-dd，直接填入；否則嘗試轉換
            const iso = parseToISODate(val);
            if (iso) el.value = iso;
            else el.value = val;
          } else {
            el.value = val;
          }
        } else if (el.tagName === 'SELECT') {
          setSelectOrCreate(el, val);
        } else if (el.tagName === 'TEXTAREA') {
          el.value = val;
        }
      });

      // 4) 緊急聯絡人：尋找 .contact-grid 並解析 .cell（header 後為資料）
      const contactGrid = doc.querySelector('.contact-grid');
      if (contactGrid) {
        // 清除現有 contact
        document.getElementById('contacts-container').innerHTML = '';
        const cells = Array.from(contactGrid.querySelectorAll('.cell'));
        // cells 按 5 個一組：姓名、關係、市內電話、手機、住址
        for (let i = 0; i < cells.length; i += 5) {
          const name = (cells[i]   && cells[i].textContent.trim()) || '';
          const rel  = (cells[i+1] && cells[i+1].textContent.trim()) || '';
          const tel  = (cells[i+2] && cells[i+2].textContent.trim()) || '';
          const mob  = (cells[i+3] && cells[i+3].textContent.trim()) || '';
          const addr = (cells[i+4] && cells[i+4].textContent.trim()) || '';
          addContact({ name, rel, tel, mob, addr });
        }
      }

      // 5) 家系圖：找 .family-tree-img 的 src
      const img = doc.querySelector('.family-tree-img');
      if (img && img.src) {
        familyTreeDataUrl = img.src;
        document.getElementById('familyTreePreview').src = familyTreeDataUrl;
      }

      // 6) 助力 / 阻力：若 export 使用 two-col-output 結構
      const twoColSec = Array.from(doc.querySelectorAll('.section-block')).find(sec => {
        const h = sec.querySelector('h2');
        return h && h.textContent.trim().startsWith('七、助力及阻力');
      });
      if (twoColSec) {
        const cols = twoColSec.querySelectorAll('.col');
        if (cols.length >= 2) {
          const leftLabel = cols[0].querySelector('.label')?.textContent.replace(/：/g,'').trim();
          const leftVal   = cols[0].querySelector('.value')?.textContent.trim();
          const rightLabel= cols[1].querySelector('.label')?.textContent.replace(/：/g,'').trim();
          const rightVal  = cols[1].querySelector('.value')?.textContent.trim();
          if (leftLabel === '助力') { document.querySelector('textarea[name="strengths"]').value = leftVal || ''; }
          if (rightLabel === '阻力') { document.querySelector('textarea[name="barriers"]').value = rightVal || ''; }
        }
      }

      // 7) 如果 export 有顯示表頭 title，嘗試從檔案名或 h1 第二個取 title
      if (h1s && h1s.length > 1) {
        // 第二個 h1 可能是表單標題或固定文字，忽略
      }
      // 嘗試從 export 的 <title> 或 body h1 取得預設檔名 / 標題
      const titleTag = doc.querySelector('title');
      if (titleTag && titleTag.textContent) {
        document.getElementById('formTitle').value = titleTag.textContent.trim();
      } else if (h1s && h1s.length > 1) {
        document.getElementById('formTitle').value = h1s[1].textContent.trim();
      }
    }

    // 協助：將任一字串設定為 select 的 value，若 option 不存在則建立一個 option 並設定
    function setSelectOrCreate(selectEl, value) {
      if (!selectEl) return;
      const opts = Array.from(selectEl.options || []);
      const match = opts.find(o => o.textContent.trim() === value || o.value === value);
      if (match) {
        selectEl.value = match.value;
      } else {
        // 建立新 option 並選取
        const opt = document.createElement('option');
        opt.textContent = value;
        opt.value = value;
        selectEl.appendChild(opt);
        selectEl.value = value;
      }
    }

    // 協助：嘗試將各式日期字串轉為 yyyy-mm-dd（簡單實作）
    function parseToISODate(s) {
      if (!s) return '';
      s = s.trim();
      // 已經是 yyyy-mm-dd
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      // 常見格式：yyyy/mm/dd 或 yyyy.mm.dd
      const m = s.match(/^(\d{4})[\/\.\-](\d{1,2})[\/\.\-](\d{1,2})$/);
      if (m) {
        const y = m[1], mm = String(m[2]).padStart(2,'0'), dd = String(m[3]).padStart(2,'0');
        return `${y}-${mm}-${dd}`;
      }
      // 其他：回傳原字串（瀏覽器可能無法接受）
      return s;
    }

  </script>
</body>
</html>
