<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å€‹æ¡ˆè³‡æ–™è¼¸å…¥èˆ‡åŒ¯å‡º v0.2.1</title>
  <!-- è¡¨å–®æ¨£å¼ -->
  <style id="formStyles">
    body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f0f2f5;
    }
    input,textarea,select,option{
      font-size: 24px;
    }
    form#caseForm {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    button {
      background: #4a90e2;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #357ab8;
    }
    .form-section {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .form-section h2 {
      margin: 0 0 8px;
      padding-bottom: 8px;
      border-bottom: 2px solid #4a90e2;
      font-size: 28px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      column-gap: 16px;
      row-gap: 12px;
      align-items: center;
    }
    .form-grid textarea {
      resize: vertical;
      min-height: 60px;
    }
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      column-gap: 16px;
      row-gap: 12px;
    }
    .contacts .contact {
      margin-bottom: 12px;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      position: relative;
    }
    .contacts .contact .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    #familyTreePreview {
      max-width: 100%;
      margin-top: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #downloadBtn {
      display: block;
      margin: 20px auto 0;
    }
    .top-controls {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      margin-bottom:12px;
    }
  </style>

  <!-- åŒ¯å‡ºé é¢æ¨£å¼ -->
  <style id="exportStyles">
    @page {
      size: A4;
      margin: 10mm;
    }
    body, html {
      margin: 0;
      padding: 0;
      font-size: 24px;
    }
    h1 {
      text-align: center;
    }
    .page {
      width: 1000px;
      min-height: 1120px;
      margin: 20px auto;
      padding: 40px;
      box-sizing: border-box;
      background: #fff;
      page-break-after: always;
    }
    .section-block {
      margin-top: 24px;
    }
    .section-block h2 {
      margin: 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #4a90e2;
      font-size: 28px;
    }
    .field-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px 24px;
      margin-top: 12px;
    }
    .field {
      display: flex;
    }
    .field .label {
      flex-shrink: 0;
      width: 100px;
      font-weight: bold;
      white-space: nowrap;
      font-size: 24px;
      margin: 16px;
    }
    .field .value {
      flex: 1;
      font-size: 24px;
      margin: 16px;
      white-space: normal;
      word-break: break-all;
      overflow-wrap: break-word;
      min-width: 0;
    }
    /* å–®ä¸€æ¬„ä½è·¨æ»¿æ•´è¡Œï¼Œåªæœ‰è¶…å‡ºé é¢å¯¬åº¦æ‰æ›è¡Œ */
    .field-grid .field:last-child {
      grid-column: 1 / -1;
    }

    /* å®¶ç³»åœ–ç½®ä¸­ */
    .family-tree-img {
      display: block;
      margin: 12px auto;
      max-width: 100%;
      border: 1px solid #ccc;
    }
    .two-col-output {
      display: flex;
      gap: 40px;
      margin-top: 12px;
    }
    .two-col-output .col .label {
      font-weight: bold;
      margin-bottom: 4px;
    }
    /* 5 æ¬„ç·Šæ€¥è¯çµ¡äºº */
    .contact-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px 16px;
      margin-top: 12px;
    }
    .contact-grid .header {
      font-weight: bold;
      background: #f3f3f3;
      padding: 8px;
    }
    .contact-grid .cell {
      padding: 8px;
      word-break: break-all;
    }
  </style>
</head>
<body>

  <div class="top-controls">
    <!-- æ–°å¢ï¼šåŒ¯å…¥åŒ¯å‡ºæª”æ¡ˆï¼ˆè¼‰å…¥åŒ¯å‡º HTML ä¸¦å›å¡«è¡¨å–®ï¼‰ -->
    <input type="file" id="importFileInput" accept=".html,text/html" />
    <button type="button" id="importBtn">è¼‰å…¥åŒ¯å‡ºæª”ä¸¦å›å¡«è¡¨å–®</button>
  </div>

  <form id="caseForm">
    <select name="facility" id="facilitySelect">
      <option>æ–°åŒ—å¸‚ç§ç«‹è±ç¦¾è€äººé•·æœŸç…§é¡§ä¸­å¿ƒ(é¤Šè­·å‹)</option>
      <option>æ–°åŒ—å¸‚ç§ç«‹éœåœ’è€äººé•·æœŸç…§é¡§ä¸­å¿ƒ(é¤Šè­·å‹)</option>
    </select>
    <input type="text" id="formTitle" placeholder="E1è·¯äººç”²åŸºæœ¬è³‡æ–™è¡¨" />
    <!-- ä¸€ã€å€‹æ¡ˆåŸºæœ¬è³‡æ–™ -->
    <section class="form-section">
      <h2>ä¸€ã€å€‹æ¡ˆåŸºæœ¬è³‡æ–™</h2>
      <div class="form-grid">
        <label>å§“å</label><input type="text" name="name" />
        <label>æ€§åˆ¥</label>
        <select name="gender">
          <option>å¥³</option>
          <option>ç”·</option>
        </select>
        <label>é«”æª¢é†«é™¢</label><input type="text" name="hospital" />
        <label>å…¥ä½æ—¥æœŸ</label><input type="date" name="checkinDate" />
        <label>å‡ºç”Ÿæ—¥æœŸ</label><input type="date" name="dob" />
        <label>èº«åˆ†è­‰</label><input type="text" name="idNo" />
        <label>æˆ¶ç±åœ°å€</label><input type="text" name="address" />
      </div>
    </section>

    <!-- äºŒã€ç·Šæ€¥è¯çµ¡äºº -->
    <section class="form-section contacts">
      <h2>äºŒã€ç·Šæ€¥è¯çµ¡äºº <button type="button" id="addContactBtn">ï¼‹æ–°å¢</button></h2>
      <div id="contacts-container"></div>
    </section>

    <!-- ä¸‰ã€ç¤¾æœƒç¦åˆ©åˆ¥ -->
    <section class="form-section">
      <h2>ä¸‰ã€ç¤¾æœƒç¦åˆ©åˆ¥</h2>
      <div class="form-grid">
        <label>èº«ä»½åˆ¥</label>
        <select name="socialId">
          <option>ä¸€èˆ¬æˆ¶</option>
          <option>ä¸­ä½1.5</option>
          <option>æ¦®æ°‘</option>
          <option>æ¦®çœ·</option>
        </select>
        <label>ä¿éšªç¨®é¡</label>
        <select name="insuranceType">
          <option>å¥ä¿</option>
          <option>å¥ä¿åŠè¾²ä¿</option>
          <option>å¥ä¿åŠå‹ä¿</option>
        </select>
        <label>ç¶“æ¿Ÿä¾†æº</label>
        <select name="incomeSource">
          <option>å­å¥³ä¾›é¤Š</option>
          <option>çˆ¶æ¯ä¾›é¤Š</option>
          <option>é€€ä¼‘ä¿¸</option>
          <option>ä¿è­·å®‰ç½®</option>
        </select>
        <label>èº«éšœè­‰æ˜</label><input type="text" name="disabilityProof" />
      </div>
    </section>

    <!-- å››ã€ç”Ÿç† / å¿ƒç†åŠŸèƒ½è©•ä¼° -->
    <section class="form-section">
      <h2>å››ã€ç”Ÿç† / å¿ƒç†åŠŸèƒ½è©•ä¼°</h2>
      <div class="form-grid">
        <label>èªçŸ¥ç‹€æ…‹</label>
        <select name="cognition">
          <option>æ··äº‚</option>
          <option>æ¸…é†’</option>
          <option>ç„¡æ³•è©•ä¼°</option>
        </select>
        <label>è¼”å…·ä½¿ç”¨</label><input type="text" name="assistiveDevices" />
        <label>ç®¡è·¯</label>
        <select name="tubes">
          <option>ç„¡</option>
          <option>é¼»èƒƒç®¡</option>
          <option>å°å°¿ç®¡</option>
          <option>é¼»èƒƒç®¡åŠå°å°¿ç®¡</option>
        </select>
        <label>è¡¨é”èƒ½åŠ›</label>
        <select name="expression">
          <option>å·®</option>
          <option>ä½³</option>
          <option>ç„¡æ³•è¡¨é”</option>
        </select>
        <label>é£²é£Ÿå½¢æ…‹</label>
        <select name="diet">
          <option>è»Ÿè³ª</option>
          <option>ç®¡çŒ</option>
        </select>
        <label>å…¥ä½æ„é¡˜</label>
        <select name="admission">
          <option>å¯æ¥å—</option>
          <option>è¢«å‘ŠçŸ¥ç„¡åæ‡‰</option>
          <option>ç„¡æ³•æ¥å—</option>
          <option>æœªè¢«å‘ŠçŸ¥</option>
        </select>
        <label>è©•ä¼°æ‘˜è¦</label><textarea name="evalSummary"></textarea>
      </div>
    </section>

    <!-- äº”ã€å®¶åº­åŠç¤¾æœƒè©•ä¼° -->
    <section class="form-section">
      <h2>äº”ã€å®¶åº­åŠç¤¾æœƒè©•ä¼°</h2>
      <div class="form-grid">
        <label>æ•™è‚²ç¨‹åº¦</label>
        <select name="education">
          <option>å°å­¸</option>
          <option>ä¸­å­¸</option>
          <option>é«˜ä¸­è·</option>
          <option>å¤§å­¸ä»¥ä¸Š</option>
          <option>ä¸è­˜å­—</option>
        </select>
        <label>éå»è·æ¥­</label><input type="text" name="pastJob" />
        <label>ç”³è«‹æœå‹™åŸå› </label>
        <select name="serviceReason">
          <option>è¦ªäººç„¡åŠ›ç…§é¡§</option>
          <option>è‡ªé¡˜å…¥ä½</option>
        </select>
        <label>å±…ä½æƒ…å½¢</label>
        <select name="livingSituation">
          <option>èˆ‡å­å¥³åŒä½</option>
          <option>èˆ‡é…å¶åŒä½</option>
          <option>ç¨å±…</option>
        </select>
        <label>å©šå§»ç‹€æ³</label>
        <select name="maritalStatus">
          <option>å–ªå¶</option>
          <option>å·²å©š</option>
          <option>é›¢å©š</option>
          <option>æœªå©š</option>
          <option>åŒå±…</option>
          <option>åˆ†å±…</option>
        </select>
        <label>ç”Ÿæ´»ä½œæ¯</label>
        <select name="dailyRoutine">
          <option>æ··äº‚</option>
          <option>è¦å¾‹</option>
        </select>
        <label>ä¸»è¦ç…§é¡§è€…</label><input type="text" name="mainCarer" />
        <label>ä¸»è¦æ±ºç­–è€…</label><input type="text" name="mainDecisionMaker" />
        <label>å®—æ•™ä¿¡ä»°</label>
        <select name="religion">
          <option>æ°‘é–“ä¿¡ä»°</option>
          <option>ä½›æ•™</option>
          <option>é“æ•™</option>
          <option>åŸºç£æ•™</option>
          <option>ä¸€è²«é“</option>
        </select>
        <label>å®¶åº­é—œä¿‚</label><textarea name="familyRelation"></textarea>
      </div>
    </section>

    <!-- å…­ã€å®¶ç³»åœ– -->
    <section class="form-section">
      <h2>å…­ã€å®¶ç³»åœ– ğŸ“·</h2>
      <input type="file" accept="image/*" id="familyTreeInput" />
      <img id="familyTreePreview" src="" alt="å®¶ç³»åœ–é è¦½" />
    </section>

    <!-- ä¸ƒã€åŠ©åŠ›ï¼é˜»åŠ› -->
    <section class="form-section">
      <h2>ä¸ƒã€åŠ©åŠ›åŠé˜»åŠ›</h2>
      <div class="two-col">
        <div>
          <label>åŠ©åŠ›</label>
          <textarea name="strengths"></textarea>
        </div>
        <div>
          <label>é˜»åŠ›</label>
          <textarea name="barriers"></textarea>
        </div>
      </div>
    </section>

    <!-- å…«ã€å€‹æ¡ˆä¾†æºèˆ‡é€€ä½æ—¥æœŸ -->
    <section class="form-section">
      <h2>å…«ã€å€‹æ¡ˆä¾†æºèˆ‡é€€ä½æ—¥æœŸ</h2>
      <div class="form-grid">
        <label>å€‹æ¡ˆä¾†æº</label>
        <select name="caseSource">
          <option>è‡ªè¡Œè¯çµ¡</option>
          <option>é†«é™¢è½‰ä»‹</option>
          <option>å…¶ä»–æ©Ÿæ§‹</option>
          <option>ä¿è­·å®‰ç½®</option>
        </select>
        <label>é€€ä½æ—¥æœŸ</label><input type="date" name="checkoutDate" />
      </div>
    </section>

    <button type="button" id="downloadBtn">ç”Ÿæˆè¡¨å–®</button>
    <a href="./ç”Ÿæ´»å…¬ç´„åŠæ¬ŠåŠ›ç¾©å‹™.html">ç”Ÿæ´»å…¬ç´„</a>
  </form>

  <!-- ç·Šæ€¥è¯çµ¡äººç¯„æœ¬ -->
  <template id="contactTpl">
    <div class="contact">
      <button type="button" class="remove-btn">Ã—</button>
      <div class="form-grid">
        <label>å§“å</label><input type="text" name="contactName[]" />
        <label>é—œä¿‚</label><input type="text" name="contactRelation[]" />
        <label>å¸‚å…§é›»è©±</label><input type="text" name="contactTel[]" />
        <label>æ‰‹æ©Ÿ</label><input type="text" name="contactMobile[]" />
        <label>ä½å€</label><input type="text" name="contactAddress[]" />
      </div>
    </div>
  </template>

  <script>
    let familyTreeDataUrl = '';

    // æ–°å¢ï¼ç§»é™¤ç·Šæ€¥è¯çµ¡äºº
    function addContact(fields = {}) {
      const tpl = document.getElementById('contactTpl').content.cloneNode(true);
      const removeBtn = tpl.querySelector('.remove-btn');
      removeBtn.addEventListener('click', e => {
        e.target.closest('.contact').remove();
      });
      // å¡«å…¥é è¨­å€¼ï¼ˆè‹¥æœ‰ï¼‰
      if (fields.name) tpl.querySelector('input[name="contactName[]"]').value = fields.name;
      if (fields.rel)  tpl.querySelector('input[name="contactRelation[]"]').value = fields.rel;
      if (fields.tel)  tpl.querySelector('input[name="contactTel[]"]').value = fields.tel;
      if (fields.mob)  tpl.querySelector('input[name="contactMobile[]"]').value = fields.mob;
      if (fields.addr) tpl.querySelector('input[name="contactAddress[]"]').value = fields.addr;

      document.getElementById('contacts-container').appendChild(tpl);
    }

    document.getElementById('addContactBtn').addEventListener('click', () => addContact());

    // å®¶ç³»åœ–é è¦½ï¼ˆä¸Šå‚³ï¼‰
    document.getElementById('familyTreeInput').addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        familyTreeDataUrl = e.target.result;
        document.getElementById('familyTreePreview').src = familyTreeDataUrl;
      };
      reader.readAsDataURL(file);
    });

    // é€šç”¨ï¼šç”Ÿæˆ 3 æ¬„å¼æ¬„ä½ç¶²æ ¼
    function renderFieldGrid(items) {
      let html = '<div class="field-grid">';
      items.forEach(({ label, value }) => {
        html += `
          <div class="field">
            <div class="label">${label}ï¼š</div>
            <div class="value">${value}</div>
          </div>`;
      });
      html += '</div>';
      return html;
    }

    // é€šç”¨ï¼šç”Ÿæˆæ–‡å­—å€å¡Š
    function renderSection(title, items) {
      return `
        <div class="section-block">
          <h2>${title}</h2>
          ${renderFieldGrid(items)}
        </div>`;
    }

    // é€šç”¨ï¼šç”Ÿæˆå®¶ç³»åœ–å€å¡Š
    function renderImageSection(title, imageUrl) {
      return `
        <div class="section-block">
          <h2>${title}</h2>
          ${imageUrl
            ? `<img src="${imageUrl}" class="family-tree-img" alt="${title}"/>`
            : '<div style="margin-top:12px;">ï¼ˆå°šæœªä¸Šå‚³å®¶ç³»åœ–ï¼‰</div>'}
        </div>`;
    }

    // é€šç”¨ï¼šç”Ÿæˆé›™æ¬„å€å¡Š
    function renderTwoColumnSection(title, left, right) {
      return `
        <div class="section-block">
          <h2>${title}</h2>
          <div class="two-col-output">
            <div class="col">
              <div class="label">${left.label}ï¼š</div>
              <div class="value">${left.value}</div>
            </div>
            <div class="col">
              <div class="label">${right.label}ï¼š</div>
              <div class="value">${right.value}</div>
            </div>
          </div>
        </div>`;
    }

    // ===== æ–°å¢ï¼š5 æ¬„ç·Šæ€¥è¯çµ¡äºº =====
    function renderContactsSection(title, contacts) {
      let html = `
        <div class="section-block">
          <h2>${title}</h2>
          <div class="contact-grid">
            <div class="header">å§“å</div>
            <div class="header">é—œä¿‚</div>
            <div class="header">å¸‚å…§é›»è©±</div>
            <div class="header">æ‰‹æ©Ÿ</div>
            <div class="header">ä½å€</div>`;
      contacts.forEach(c => {
        html += `
            <div class="cell">${c.name}</div>
            <div class="cell">${c.rel}</div>
            <div class="cell">${c.tel}</div>
            <div class="cell">${c.mob}</div>
            <div class="cell">${c.addr}</div>`;
      });
      return html + `
          </div>
        </div>`;
    }

    // ç”Ÿæˆä¸¦ä¸‹è¼‰ HTML
    document.getElementById('downloadBtn').addEventListener('click', () => {
      const formEl = document.getElementById('caseForm');
      const fd = new FormData(formEl);
      const G = key => fd.get(key) || '';

      // å¾ FormData å–å¾—å¤šç­†è¯çµ¡äººæ¬„ä½
      const names = fd.getAll('contactName[]');
      const rels  = fd.getAll('contactRelation[]');
      const tels  = fd.getAll('contactTel[]');
      const mobs  = fd.getAll('contactMobile[]');
      const addrs = fd.getAll('contactAddress[]');

      // çµ„æˆ contacts é™£åˆ—
      const contacts = names.map((name, i) => ({
        name:  name   || '',
        rel:   rels[i]   || '',
        tel:   tels[i]   || '',
        mob:   mobs[i]   || '',
        addr:  addrs[i]  || ''
      }));

      // å„å€å¡Šæ¬„ä½è³‡æ–™
      const basics = [
        { label: 'å§“å', value: G('name') },
        { label: 'æ€§åˆ¥', value: G('gender') },
        { label: 'é«”æª¢é†«é™¢', value: G('hospital') },
        { label: 'å…¥ä½æ—¥æœŸ', value: G('checkinDate') },
        { label: 'å‡ºç”Ÿæ—¥æœŸ', value: G('dob') },
        { label: 'èº«åˆ†è­‰', value: G('idNo') },
        { label: 'æˆ¶ç±åœ°å€', value: G('address') }
      ];
      const social = [
        { label: 'èº«ä»½åˆ¥', value: G('socialId') },
        { label: 'ä¿éšªç¨®é¡', value: G('insuranceType') },
        { label: 'ç¶“æ¿Ÿä¾†æº', value: G('incomeSource') },
        { label: 'èº«éšœè­‰æ˜', value: G('disabilityProof') }
      ];
      const evaluation = [
        { label: 'èªçŸ¥ç‹€æ…‹', value: G('cognition') },
        { label: 'è¼”å…·ä½¿ç”¨', value: G('assistiveDevices') },
        { label: 'ç®¡è·¯', value: G('tubes') },
        { label: 'è¡¨é”èƒ½åŠ›', value: G('expression') },
        { label: 'é£²é£Ÿå½¢æ…‹', value: G('diet') },
        { label: 'å…¥ä½æ„é¡˜', value: G('admission') },
        { label: 'è©•ä¼°æ‘˜è¦', value: G('evalSummary') }
      ];
      const familySocial = [
        { label: 'æ•™è‚²ç¨‹åº¦', value: G('education') },
        { label: 'éå»è·æ¥­', value: G('pastJob') },
        { label: 'å…¥ä½åŸå› ', value: G('serviceReason') },
        { label: 'å±…ä½æƒ…å½¢', value: G('livingSituation') },
        { label: 'å©šå§»ç‹€æ³', value: G('maritalStatus') },
        { label: 'ç”Ÿæ´»ä½œæ¯', value: G('dailyRoutine') },
        { label: 'ç…§é¡§è€…', value: G('mainCarer') },
        { label: 'æ±ºç­–è€…', value: G('mainDecisionMaker') },
        { label: 'å®—æ•™ä¿¡ä»°', value: G('religion') },
        { label: 'å®¶åº­é—œä¿‚', value: G('familyRelation') }
      ];
      const caseSource = [ 
        { label: 'å€‹æ¡ˆä¾†æº', value: G('caseSource') },
        { label: 'é€€ä½æ—¥æœŸ', value: G('checkoutDate')},
        { label: 'ä¸»ç®¡', value: ''},
        { label: 'å¡«è¡¨è€…', value: ''}
      ];
      const treeUrl = familyTreeDataUrl;

      // çµ„é å…§å®¹
      const pages = [];
      pages.push(`
        <div class="page">
          <h1>${G('facility')}</h1>
          <h1>ä½æ°‘åŸºæœ¬è³‡æ–™è¡¨</h1>
          ${renderSection('ä¸€ã€å€‹æ¡ˆåŸºæœ¬è³‡æ–™', basics)}
          ${renderContactsSection('äºŒã€ç·Šæ€¥è¯çµ¡äºº', contacts)}
          ${renderSection('ä¸‰ã€ç¤¾æœƒç¦åˆ©åˆ¥', social)}
          ${renderSection('å››ã€ç”Ÿç†ï¼å¿ƒç†åŠŸèƒ½è©•ä¼°', evaluation)}
        </div>`);
      pages.push(`
        <div class="page">
          ${renderSection('äº”ã€å®¶åº­åŠç¤¾æœƒè©•ä¼°', familySocial)}
          ${renderImageSection('å…­ã€å®¶ç³»åœ–', treeUrl)}
          ${renderTwoColumnSection('ä¸ƒã€åŠ©åŠ›åŠé˜»åŠ›',
            { label: 'åŠ©åŠ›', value: G('strengths') },
            { label: 'é˜»åŠ›', value: G('barriers') }
          )}
          ${renderSection('å…«ã€å€‹æ¡ˆä¾†æºèˆ‡é€€ä½æ—¥æœŸ',
            caseSource
          )}
        </div>`);

      // æœ€çµ‚ HTML
      const exportCss = document.getElementById('exportStyles').innerText;
      const finalHtml = `<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å€‹æ¡ˆè³‡æ–™å ±è¡¨</title>
  <style>${exportCss}</style>
</head>
<body>
  ${pages.join('')}
</body>
</html>`;

      // è§¸ç™¼ä¸‹è¼‰
      const blob = new Blob([finalHtml], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const safeTitle = (document.getElementById('formTitle').value || 'ä½æ°‘åŸºæœ¬è³‡æ–™è¡¨').replace(/\s+/g, "_");
      a.href = url;
      a.download = `${safeTitle}.html`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // ============================
    // åŒ¯å…¥åŠŸèƒ½ï¼šè¼‰å…¥åŒ¯å‡ºæª”ä¸¦å›å¡«è¡¨å–®
    // ============================
    document.getElementById('importBtn').addEventListener('click', () => {
      const fileInput = document.getElementById('importFileInput');
      const f = fileInput.files && fileInput.files[0];
      if (!f) {
        alert('è«‹å…ˆé¸æ“‡åŒ¯å‡ºçš„ HTML æª”æ¡ˆï¼ˆç”±ã€Œç”Ÿæˆè¡¨å–®ã€ä¸‹è¼‰ï¼‰ã€‚');
        return;
      }
      const reader = new FileReader();
      reader.onload = e => {
        try {
          parseExportHtml(e.target.result);
          alert('å·²å¾åŒ¯å‡ºæª”å›å¡«è¡¨å–®ï¼ˆå¦‚æœ‰å®¶ç³»åœ–æœƒé¡¯ç¤ºï¼‰ã€‚');
        } catch (err) {
          console.error(err);
          alert('è§£æåŒ¯å‡ºæª”æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯ç”±æœ¬ç³»çµ±ã€Œç”Ÿæˆè¡¨å–®ã€åŒ¯å‡ºçš„ HTMLã€‚');
        }
      };
      reader.readAsText(f, 'utf-8');
    });

    // è§£æåŒ¯å‡º HTML ä¸¦å›å¡«è¡¨å–®
    function parseExportHtml(htmlText) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlText, 'text/html');

      // 1) å„ªå…ˆå–ç¬¬ä¸€å€‹ h1 ä½œç‚º facilityï¼ˆåŒ¯å‡ºæ™‚ç¬¬ä¸€å€‹ h1 å­˜æ”¾æ©Ÿæ§‹åç¨±ï¼‰
      const h1s = doc.querySelectorAll('h1');
      if (h1s && h1s.length > 0) {
        const facility = h1s[0].textContent.trim();
        setSelectOrCreate(document.querySelector('select[name="facility"]'), facility);
      }

      // 2) æ”¶é›†æ‰€æœ‰ .fieldï¼ˆlabel / valueï¼‰å°
      const fields = {};
      const fieldNodes = doc.querySelectorAll('.field');
      fieldNodes.forEach(f => {
        const lblEl = f.querySelector('.label');
        const valEl = f.querySelector('.value');
        if (!lblEl || !valEl) return;
        let label = lblEl.textContent.replace(/ï¼š/g, '').trim();
        let value = valEl.textContent.trim();
        fields[label] = value;
      });

      // 3) mappingï¼šå°‡è¼¸å‡º label å°æ‡‰å›è¡¨å–® name
      const labelToName = {
        'å§“å':'name','æ€§åˆ¥':'gender','é«”æª¢é†«é™¢':'hospital','å…¥ä½æ—¥æœŸ':'checkinDate',
        'å‡ºç”Ÿæ—¥æœŸ':'dob','èº«åˆ†è­‰':'idNo','æˆ¶ç±åœ°å€':'address','èº«ä»½åˆ¥':'socialId',
        'ä¿éšªç¨®é¡':'insuranceType','ç¶“æ¿Ÿä¾†æº':'incomeSource','èº«éšœè­‰æ˜':'disabilityProof',
        'èªçŸ¥ç‹€æ…‹':'cognition','è¼”å…·ä½¿ç”¨':'assistiveDevices','ç®¡è·¯':'tubes','è¡¨é”èƒ½åŠ›':'expression',
        'é£²é£Ÿå½¢æ…‹':'diet','å…¥ä½æ„é¡˜':'admission','è©•ä¼°æ‘˜è¦':'evalSummary',
        'æ•™è‚²ç¨‹åº¦':'education','éå»è·æ¥­':'pastJob','å…¥ä½åŸå› ':'serviceReason','å±…ä½æƒ…å½¢':'livingSituation',
        'å©šå§»ç‹€æ³':'maritalStatus','ç”Ÿæ´»ä½œæ¯':'dailyRoutine','ç…§é¡§è€…':'mainCarer','æ±ºç­–è€…':'mainDecisionMaker',
        'å®—æ•™ä¿¡ä»°':'religion','å®¶åº­é—œä¿‚':'familyRelation','å€‹æ¡ˆä¾†æº':'caseSource','é€€ä½æ—¥æœŸ':'checkoutDate',
        'åŠ©åŠ›':'strengths','é˜»åŠ›':'barriers','ä¸»ç®¡':'supervisor','å¡«è¡¨è€…':'filler'
      };

      // å¡«å…¥æ¬„ä½ï¼ˆæ–‡å­— / select / textarea / dateï¼‰
      Object.entries(labelToName).forEach(([label, name]) => {
        if (!(label in fields)) return;
        const val = fields[label];
        const el = document.querySelector(`[name="${name}"]`);
        if (!el) {
          // è‹¥ç„¡å°æ‡‰æ¬„ä½ï¼ˆä¾‹å¦‚ supervisor / fillerï¼‰ï¼Œå¿½ç•¥æˆ–å¯ä»¥æ“´å……è™•ç†
          return;
        }
        if (el.tagName === 'INPUT') {
          // date æˆ– text
          // å¦‚æœæ˜¯ date è¼¸å…¥ï¼Œå˜—è©¦è§£ææˆ yyyy-mm-ddï¼ˆåŒ¯å‡ºé€šå¸¸æ˜¯åŸå€¼ï¼‰
          if (el.type === 'date') {
            // å¦‚æœåŒ¯å‡ºçš„æ ¼å¼ç‚º yyyy-mm-ddï¼Œç›´æ¥å¡«å…¥ï¼›å¦å‰‡å˜—è©¦è½‰æ›
            const iso = parseToISODate(val);
            if (iso) el.value = iso;
            else el.value = val;
          } else {
            el.value = val;
          }
        } else if (el.tagName === 'SELECT') {
          setSelectOrCreate(el, val);
        } else if (el.tagName === 'TEXTAREA') {
          el.value = val;
        }
      });

      // 4) ç·Šæ€¥è¯çµ¡äººï¼šå°‹æ‰¾ .contact-grid ä¸¦è§£æ .cellï¼ˆheader å¾Œç‚ºè³‡æ–™ï¼‰
      const contactGrid = doc.querySelector('.contact-grid');
      if (contactGrid) {
        // æ¸…é™¤ç¾æœ‰ contact
        document.getElementById('contacts-container').innerHTML = '';
        const cells = Array.from(contactGrid.querySelectorAll('.cell'));
        // cells æŒ‰ 5 å€‹ä¸€çµ„ï¼šå§“åã€é—œä¿‚ã€å¸‚å…§é›»è©±ã€æ‰‹æ©Ÿã€ä½å€
        for (let i = 0; i < cells.length; i += 5) {
          const name = (cells[i]   && cells[i].textContent.trim()) || '';
          const rel  = (cells[i+1] && cells[i+1].textContent.trim()) || '';
          const tel  = (cells[i+2] && cells[i+2].textContent.trim()) || '';
          const mob  = (cells[i+3] && cells[i+3].textContent.trim()) || '';
          const addr = (cells[i+4] && cells[i+4].textContent.trim()) || '';
          addContact({ name, rel, tel, mob, addr });
        }
      }

      // 5) å®¶ç³»åœ–ï¼šæ‰¾ .family-tree-img çš„ src
      const img = doc.querySelector('.family-tree-img');
      if (img && img.src) {
        familyTreeDataUrl = img.src;
        document.getElementById('familyTreePreview').src = familyTreeDataUrl;
      }

      // 6) åŠ©åŠ› / é˜»åŠ›ï¼šè‹¥ export ä½¿ç”¨ two-col-output çµæ§‹
      const twoColSec = Array.from(doc.querySelectorAll('.section-block')).find(sec => {
        const h = sec.querySelector('h2');
        return h && h.textContent.trim().startsWith('ä¸ƒã€åŠ©åŠ›åŠé˜»åŠ›');
      });
      if (twoColSec) {
        const cols = twoColSec.querySelectorAll('.col');
        if (cols.length >= 2) {
          const leftLabel = cols[0].querySelector('.label')?.textContent.replace(/ï¼š/g,'').trim();
          const leftVal   = cols[0].querySelector('.value')?.textContent.trim();
          const rightLabel= cols[1].querySelector('.label')?.textContent.replace(/ï¼š/g,'').trim();
          const rightVal  = cols[1].querySelector('.value')?.textContent.trim();
          if (leftLabel === 'åŠ©åŠ›') { document.querySelector('textarea[name="strengths"]').value = leftVal || ''; }
          if (rightLabel === 'é˜»åŠ›') { document.querySelector('textarea[name="barriers"]').value = rightVal || ''; }
        }
      }

      // 7) å¦‚æœ export æœ‰é¡¯ç¤ºè¡¨é ­ titleï¼Œå˜—è©¦å¾æª”æ¡ˆåæˆ– h1 ç¬¬äºŒå€‹å– title
      if (h1s && h1s.length > 1) {
        // ç¬¬äºŒå€‹ h1 å¯èƒ½æ˜¯è¡¨å–®æ¨™é¡Œæˆ–å›ºå®šæ–‡å­—ï¼Œå¿½ç•¥
      }
      // å˜—è©¦å¾ export çš„ <title> æˆ– body h1 å–å¾—é è¨­æª”å / æ¨™é¡Œ
      const titleTag = doc.querySelector('title');
      if (titleTag && titleTag.textContent) {
        document.getElementById('formTitle').value = titleTag.textContent.trim();
      } else if (h1s && h1s.length > 1) {
        document.getElementById('formTitle').value = h1s[1].textContent.trim();
      }
    }

    // å”åŠ©ï¼šå°‡ä»»ä¸€å­—ä¸²è¨­å®šç‚º select çš„ valueï¼Œè‹¥ option ä¸å­˜åœ¨å‰‡å»ºç«‹ä¸€å€‹ option ä¸¦è¨­å®š
    function setSelectOrCreate(selectEl, value) {
      if (!selectEl) return;
      const opts = Array.from(selectEl.options || []);
      const match = opts.find(o => o.textContent.trim() === value || o.value === value);
      if (match) {
        selectEl.value = match.value;
      } else {
        // å»ºç«‹æ–° option ä¸¦é¸å–
        const opt = document.createElement('option');
        opt.textContent = value;
        opt.value = value;
        selectEl.appendChild(opt);
        selectEl.value = value;
      }
    }

    // å”åŠ©ï¼šå˜—è©¦å°‡å„å¼æ—¥æœŸå­—ä¸²è½‰ç‚º yyyy-mm-ddï¼ˆç°¡å–®å¯¦ä½œï¼‰
    function parseToISODate(s) {
      if (!s) return '';
      s = s.trim();
      // å·²ç¶“æ˜¯ yyyy-mm-dd
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      // å¸¸è¦‹æ ¼å¼ï¼šyyyy/mm/dd æˆ– yyyy.mm.dd
      const m = s.match(/^(\d{4})[\/\.\-](\d{1,2})[\/\.\-](\d{1,2})$/);
      if (m) {
        const y = m[1], mm = String(m[2]).padStart(2,'0'), dd = String(m[3]).padStart(2,'0');
        return `${y}-${mm}-${dd}`;
      }
      // å…¶ä»–ï¼šå›å‚³åŸå­—ä¸²ï¼ˆç€è¦½å™¨å¯èƒ½ç„¡æ³•æ¥å—ï¼‰
      return s;
    }

  </script>
</body>
</html>
